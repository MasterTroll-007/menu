<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout" lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Ingredience</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <link href="https://nightly.datatables.net/css/jquery.dataTables.css" rel="stylesheet" type="text/css" />
    <script src="https://nightly.datatables.net/js/jquery.dataTables.js"></script>
    <link href="https://nightly.datatables.net/responsive/css/responsive.dataTables.css?_=13da4d8e7c1d2bdf6e3a5bdfe17b9f67.css" rel="stylesheet" type="text/css" />
    <script src="https://nightly.datatables.net/responsive/js/dataTables.responsive.js?_=13da4d8e7c1d2bdf6e3a5bdfe17b9f67"></script>

    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}">

</head>
<body>
<div th:insert="navbar :: navbar"></div>


<div layout:fragment="content">

    <h2>Seznam ingrediencí</h2>

    <table class="table table-sm table-striped table-responsive" data-page-length="25" id="ingredients-table">
        <thead>
        <tr>
            <th></th>
            <th data-orderable="true" data-searchable="true" scope="col">name</th>
            <th data-orderable="true" data-searchable="false" scope="col">carbohydrates</th>
            <th data-orderable="true" data-searchable="false" scope="col">proteins</th>
            <th data-orderable="true" data-searchable="false" scope="col">fats</th>
            <th data-orderable="true" data-searchable="false" scope="col">fibre</th>
            <th data-orderable="false" data-searchable="false" scope="col">upravit</th>
            <th data-orderable="false" data-searchable="false" scope="col">smazat</th>
            <th data-orderable="false" data-searchable="false" scope="col" style="display: none">id</th>

        </tr>
        </thead>
    </table>

    <script th:inline="javascript">
        $(document).ready(function () {
            var $ingredientsTable = $('#ingredients-table'),
                csrfToken = $("meta[name='_csrf']").attr("content"),
                csrfHeader = $("meta[name='_csrf_header").attr('content');

            var ingredientsDataTable = $ingredientsTable.DataTable({
                'ajax': '/ingredients/api/v1',
                'serverSide': false,
                "processing": true,
                'language': {
                    processing: '<div class="loader"></div>'
                },
                columns: [
                    {
                        data: null,
                        defaultContent: '',
                        className: 'control',
                        orderable: false,
                        searchable: false
                    },
                    {data: 'name'},
                    {data: 'carbohydrates'},
                    {data: 'proteins'},
                    {data: 'fats'},
                    {data: 'fibre'},

                    {
                        render: function (data, type, row) {
                            return '<button class="ingredient-update btn btn-info btn-sm" data-id="' + row.id + '">upravit</button>';
                        }
                    },
                    {
                        render: function (data, type, row) {
                            return '<button class="ingredient-remove btn btn-info btn-sm" data-id="' + row.id + '">smazat</button>';
                        }
                    },
                    {data: 'id', visible: false}
                ]
            });

            $ingredientsTable.on('click', '.ingredient-update', function () {
                var id = $(this).attr('data-id');
                var td = $(this).closest('td');

                sendRequest(id, td);
            });

            $ingredientsTable.on('click', '.ingredient-remove', function () {
                var id = $(this).attr('data-id');
                var td = $(this).closest('td');

                sendRequest(id, td, true);
            });

            function sendRequest(id, td, remove) {
                $.ajax({
                    type: "POST",
                    url: "/ingredients/api/v1/" + id + (remove ? '/remove' : '/edit'),
                    beforeSend: function (xhr) {
                        td.find('span').remove();
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    },
                    success: function () {
                        ingredientsDataTable.cell(td)
                            .invalidate()
                            .draw(false);
                    },
                    error: function () {
                        td.append('<span style="color: red; margin-left: 5px;">Ups, něco se pokazilo, opakuje akci později.</span>')
                    }
                });
            }

        });

    </script>
</div>


</body>
</html>